{% extends "base.html" %}

{% block title %}장바구니 - 카페 주문 관리 시스템{% endblock %}

{% block content %}
<!-- 헤더 -->
<div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
    <h1 class="h2">
        <i class="fas fa-shopping-cart text-primary"></i> 장바구니
    </h1>
    <div class="btn-toolbar mb-2 mb-md-0">
        <a href="{{ url_for('user_menu') }}" class="btn btn-outline-primary">
            <i class="fas fa-arrow-left"></i> 메뉴로 돌아가기
        </a>
    </div>
</div>

{% if cart %}
    <div class="row">
        <!-- 장바구니 아이템 목록 -->
        <div class="col-lg-8">
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-list"></i> 주문 목록
                        <span class="badge bg-primary ms-2">{{ cart|length }}개 아이템</span>
                    </h5>
                </div>
                <div class="card-body p-0">
                    {% for item in cart %}
                        <div class="d-flex align-items-center p-3 border-bottom">
                            <div class="flex-grow-1">
                                <h6 class="mb-1">{{ item.menu_name }}</h6>
                                <div class="small text-muted">
                                    {% if item.temperature %}
                                        <span class="badge bg-{{ 'danger' if item.temperature == 'hot' else 'info' }} me-1">
                                            {% if item.temperature == 'hot' %}
                                                <i class="fas fa-fire"></i> Hot
                                            {% else %}
                                                <i class="fas fa-snowflake"></i> Ice
                                            {% endif %}
                                        </span>
                                    {% endif %}
                                    
                                    {% if item.special_request %}
                                        <div class="mt-1">
                                            <i class="fas fa-comment-dots"></i> {{ item.special_request }}
                                        </div>
                                    {% endif %}
                                </div>
                            </div>
                            
                            <div class="text-center mx-3">
                                <div class="small text-muted">단가</div>
                                <strong>{{ item.price|currency }}</strong>
                            </div>
                            
                            <div class="text-center mx-3">
                                <form method="POST" action="{{ url_for('update_cart') }}" class="d-inline">
                                    <input type="hidden" name="action" value="update">
                                    <input type="hidden" name="index" value="{{ loop.index0 }}">
                                    <div class="input-group" style="width: 120px;">
                                        <button type="button" class="btn btn-outline-secondary btn-sm" 
                                                onclick="changeCartQuantity(this, -1)">
                                            <i class="fas fa-minus"></i>
                                        </button>
                                        <input type="number" class="form-control form-control-sm text-center" 
                                               name="quantity" value="{{ item.quantity }}" min="1" max="99"
                                               onchange="this.form.submit()">
                                        <button type="button" class="btn btn-outline-secondary btn-sm" 
                                                onclick="changeCartQuantity(this, 1)">
                                            <i class="fas fa-plus"></i>
                                        </button>
                                    </div>
                                </form>
                            </div>
                            
                            <div class="text-center mx-3">
                                <div class="small text-muted">소계</div>
                                <strong class="text-primary">{{ item.subtotal|currency }}</strong>
                            </div>
                            
                            <div class="text-center">
                                <form method="POST" action="{{ url_for('update_cart') }}" class="d-inline">
                                    <input type="hidden" name="action" value="remove">
                                    <input type="hidden" name="index" value="{{ loop.index0 }}">
                                    <button type="submit" class="btn btn-outline-danger btn-sm" 
                                            onclick="return confirm('이 아이템을 삭제하시겠습니까?')">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </form>
                            </div>
                        </div>
                    {% endfor %}
                </div>
            </div>
            
            <!-- 장바구니 관리 버튼 -->
            <div class="mt-3">
                <form method="POST" action="{{ url_for('clear_cart') }}" class="d-inline">
                    <button type="submit" class="btn btn-outline-danger" 
                            onclick="return confirm('장바구니를 비우시겠습니까?')">
                        <i class="fas fa-trash-alt"></i> 장바구니 비우기
                    </button>
                </form>
            </div>
        </div>
        
        <!-- 주문 요약 및 결제 -->
        <div class="col-lg-4">
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-receipt"></i> 주문 요약
                    </h5>
                </div>
                <div class="card-body">
                    <div class="d-flex justify-content-between mb-2">
                        <span>아이템 수:</span>
                        <span>{{ cart|length }}개</span>
                    </div>
                    <div class="d-flex justify-content-between mb-2">
                        <span>총 수량:</span>
                        <span>{{ cart|sum(attribute='quantity') }}개</span>
                    </div>
                    <hr>
                    <div class="d-flex justify-content-between">
                        <strong>총 금액:</strong>
                        <strong class="text-primary h5">{{ total_amount|currency }}</strong>
                    </div>
                </div>
            </div>
            
            <!-- 주문 폼 -->
            <div class="card mt-3">
                <div class="card-header">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-user"></i> 주문 정보
                    </h5>
                </div>
                <div class="card-body">
                    <form method="POST" action="{{ url_for('place_order') }}">
                        <div class="mb-3">
                            <label for="customer_name" class="form-label">
                                <i class="fas fa-user"></i> 고객명 *
                            </label>
                            <input type="text" class="form-control" id="customer_name" 
                                   name="customer_name" required maxlength="50"
                                   placeholder="주문하시는 분의 성함을 입력해주세요">
                        </div>
                        
                        <div class="mb-3">
                            <label for="delivery_location" class="form-label">
                                <i class="fas fa-map-marker-alt"></i> 배달 위치 *
                            </label>
                            <input type="text" class="form-control" id="delivery_location" 
                                   name="delivery_location" required maxlength="100"
                                   placeholder="예: 3층 사무실, 1층 로비 등">
                        </div>
                        
                        <div class="mb-3">
                            <label for="delivery_time" class="form-label">
                                <i class="fas fa-clock"></i> 희망 배달 시간
                            </label>
                            <input type="text" class="form-control" id="delivery_time" 
                                   name="delivery_time" maxlength="50"
                                   placeholder="예: 오후 2시 30분, 점심시간 후 등 (선택사항)">
                            <div class="form-text">선택사항입니다. 비워두시면 즉시 준비됩니다.</div>
                        </div>
                        
                        <div class="mb-3">
                            <label for="order_request" class="form-label">
                                <i class="fas fa-comment"></i> 주문 요청사항
                            </label>
                            <textarea class="form-control" id="order_request" name="order_request" 
                                      rows="3" maxlength="500"
                                      placeholder="주문에 대한 추가 요청사항이 있으시면 입력해주세요 (선택사항)"></textarea>
                        </div>
                        
                        <div class="d-grid">
                            <button type="submit" class="btn btn-primary btn-lg">
                                <i class="fas fa-credit-card"></i> 주문하기
                                <small class="d-block">{{ total_amount|currency }}</small>
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
    
{% else %}
    <!-- 빈 장바구니 -->
    <div class="text-center py-5">
        <i class="fas fa-shopping-cart text-muted" style="font-size: 5rem;"></i>
        <h3 class="text-muted mt-4">장바구니가 비어있습니다</h3>
        <p class="text-muted mb-4">메뉴를 선택하여 장바구니에 담아보세요!</p>
        <a href="{{ url_for('user_menu') }}" class="btn btn-primary btn-lg">
            <i class="fas fa-utensils"></i> 메뉴 보러가기
        </a>
    </div>
{% endif %}
{% endblock %}

{% block extra_js %}
<script>
    // 장바구니 수량 변경
    function changeCartQuantity(button, delta) {
        const inputGroup = button.closest('.input-group');
        const quantityInput = inputGroup.querySelector('input[name="quantity"]');
        let quantity = parseInt(quantityInput.value) || 1;
        
        quantity += delta;
        
        if (quantity < 1) quantity = 1;
        if (quantity > 99) quantity = 99;
        
        quantityInput.value = quantity;
        
        // 폼 자동 제출
        quantityInput.form.submit();
    }
    
    // 주문 폼 검증
    document.querySelector('form[action="{{ url_for("place_order") }}"]')?.addEventListener('submit', function(e) {
        const customerName = document.getElementById('customer_name').value.trim();
        const deliveryLocation = document.getElementById('delivery_location').value.trim();
        
        if (!customerName) {
            e.preventDefault();
            alert('고객명을 입력해주세요.');
            document.getElementById('customer_name').focus();
            return;
        }
        
        if (!deliveryLocation) {
            e.preventDefault();
            alert('배달 위치를 입력해주세요.');
            document.getElementById('delivery_location').focus();
            return;
        }
        
        // 확인 대화상자
        const totalAmount = '{{ total_amount|currency }}';
        const confirmMessage = '주문하시겠습니까?\n\n고객명: ' + customerName + '\n배달 위치: ' + deliveryLocation + '\n총 금액: ' + totalAmount;
        if (!confirm(confirmMessage)) {
            e.preventDefault();
        }
    });
    
    // 실시간 입력 검증
    function validateInput(input, maxLength) {
        if (input.value.length > maxLength) {
            input.value = input.value.substring(0, maxLength);
        }
    }
    
    // 입력 필드에 실시간 검증 적용
    document.getElementById('customer_name')?.addEventListener('input', function() {
        validateInput(this, 50);
    });
    
    document.getElementById('delivery_location')?.addEventListener('input', function() {
        validateInput(this, 100);
    });
    
    document.getElementById('delivery_time')?.addEventListener('input', function() {
        validateInput(this, 50);
    });
    
    document.getElementById('order_request')?.addEventListener('input', function() {
        validateInput(this, 500);
    });
    
    // 페이지 로드 시 첫 번째 입력 필드에 포커스
    document.addEventListener('DOMContentLoaded', function() {
        const firstInput = document.getElementById('customer_name');
        if (firstInput) {
            firstInput.focus();
        }
    });
</script>
{% endblock %} 